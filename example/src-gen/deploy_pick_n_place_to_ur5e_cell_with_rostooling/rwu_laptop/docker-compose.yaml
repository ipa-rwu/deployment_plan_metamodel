version: '3'
networks:
  ros-network:
    external: false
    driver: "bridge"
  ur5e:
    driver: macvlan
    driver_opts:
      parent: enp0s31f6
    ipam:
      driver: default

services:
  ur5e_driver:
    image: ${Registry}/ur5e_driver:latest
    volumes:
      - ./cyclonedds.xml:/cyclonedds.xml
    networks:
      - ros-network
      - ur5e
    ports:
      - 50002:50002
    environment:
      - NETINTERFACE=eth0
      - robot_ip=192.168.56.2
    command:
      - bash
      - -c
      - |
        export CYCLONEDDS_URI=file:///cyclonedds.xml
        source /ros_entrypoint.sh
        ros2 launch ur_robot_driver ur5e.launch.py robot_ip:=192.168.56.2
  realsense_driver:
    image: ${Registry}/realsense_driver:latest
    volumes:
      - ./cyclonedds.xml:/cyclonedds.xml
    networks:
      - ros-network
    devices:
      - /dev/video2:/dev/video2
      - /dev/video3:/dev/video3
      - /dev/video4:/dev/video4
      - /dev/video5:/dev/video5
      - /dev/video6:/dev/video6
      - /dev/video7:/dev/video7
    environment:
      - NETINTERFACE=eth0
      - device_type=D435
    command:
      - bash
      - -c
      - |
        export CYCLONEDDS_URI=file:///cyclonedds.xml
        source /ros_entrypoint.sh
        ros2 run tf2_ros static_transform_publisher -0.00640796 -0.0551158 0.00796752 -0.529877 0.53423 -0.467606 -0.463867 tool0 camera_link &
        ros2 launch realsense2_camera rs_launch.py publish_tf:=false device_type:=D435
  marker_detection:
    image: ${Registry}/marker_detection:latest
    volumes:
      - ./cyclonedds.xml:/cyclonedds.xml
    networks:
      - ros-network
    environment:
      - NETINTERFACE=eth0
    command:
      - bash
      - -c
      - |
        export CYCLONEDDS_URI=file:///cyclonedds.xml
        source /ros_entrypoint.sh
        ros2 launch aruco_ros marker_publisher.launch.py camera_frame:=camera_color_optical_frame reference_frame:=world marker_size_arg:=0.02
  pick_place_task:
    image: ${Registry}/pick_place_task:latest
    volumes:
      - ./cyclonedds.xml:/cyclonedds.xml
    networks:
      - ros-network
    environment:
      - NETINTERFACE=eth0
    command:
      - bash
      - -c
      - |
        export CYCLONEDDS_URI=file:///cyclonedds.xml
        source /ros_entrypoint.sh
        ros2 launch pick_place_app pick_place_demo_ur5e.launch.py
